---
title: "Analysis Report"
output: rmarkdown::html_vignette
bibliography: references.bib
csl: apa.csl
vignette:  >
  %\VignetteIndexEntry{Analysis Report}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
#| label: knitr-setup

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r}
#| label: setup

library(aphantasiaEmotions)
library(patchwork)
```

# Sample description

```{r}
#| label: descriptive-stats

all_data |>
  dplyr::group_by(study) |>
  dplyr::reframe(
    Language = unique(lang),
    N = paste0(
      dplyr::n(),
      " (",
      sum(gender == "female"),
      " F, ",
      sum(gender == "other"),
      " O)"
    ),
    M_age = mean(age, na.rm = TRUE),
    SD_age = sd(age, na.rm = TRUE),
    min_age = min(age, na.rm = TRUE),
    max_age = max(age, na.rm = TRUE),
  ) |>
  knitr::kable(digits = 2)
```

```{r}
#| label: plot-proportions
#| fig.width: 8
#| fig.height: 5
#| warning: false
#| fig-alt: >
#|  Proportions of alexithymia within the VVIQ groups in the sample.

p_counts <-
  all_data |>
  dplyr::bind_rows(all_data |> dplyr::mutate(study = "total")) |>
  dplyr::mutate(
    study = factor(
      study,
      levels = c("burns", "monzel", "mas", "ruby", "kvamme", "total")
    )
  ) |>
  plot_vviq_group_proportions(vviq_group_4, base_size = 12, prop_txt_size = 3)

p_props <-
  all_data |>
  summarise_aph_and_alexi(vviq_group_4) |>
  plot_alexithymia_proportions(
    vviq_group_4,
    ncol = 6,
    base_size = 12,
    prop_txt_size = 2
  )

ggpubr::ggarrange(
  p_counts,
  p_props,
  ncol = 1,
  heights = c(1.1, 1),
  labels = "AUTO",
  font.label = list(size = 14, face = "bold")
)
```

# Modelling

## Bayesian setup

Bayesian models were fitted using the `brms::brm()` function from the *brms*
package [@burknerBrmsPackageBayesian2017] through a custom wrapper,
`fit_brms_model()`, that sets several default options for us. 24000 post-warmup
iterations were spread across all available CPU for parallel processing[^1],
with 2000 additional warmup iterations per chain. A fixed seed was used for
reproducibility. Regularising priors were used to improve convergence and avoid
overfitting. A weakly informative normal prior with mean 0 and standard
deviation 20 was used on the fixed effects to improve the default flat priors of
*brms*. Default weakly informative priors from *brms* were used for other model
parameters. The adequacy of these priors were assessed using a prior predictive
check, which is presented below. To avoid having to refit the models each time
the vignette is built and improve reproducibility, fitted models are saved in
the `models/` folder (or `inst/models/` in the source code on GitHub) and loaded in the R chunks.

[^1]: This specific number was chosen arbitrarily to have an even number of
    iterations on each chain on the two computers that were used for the
    analyses, one with 20 cores and one with 24 cores. The only important aspect
    here is to have enough iterations to ensure convergence and a good effective
    sample size.

After model fit, we checked model performance using posterior predictive checks
with the `performance::check_predictions()` function to ensure that the models
were able to reproduce the data well.

We tested our hypotheses on linear models with marginal contrasts between VVIQ
groups. This task was performed with functions from the *marginaleffects*
package. We used the `marginaleffects::avg_comparisons()` function to compute
contrasts and a custom `report_rope()` wrapper (around
`marginaleffects::posterior_draws()`, `bayestestR::rope_range()` and
`bayestestR::p_direction()`) to summarise their posterior distributions. We
computed the probability of direction (PD) of the contrasts and the proportions
of their posterior distributions below, inside or above a region of practical
equivalence to the null (ROPE) [see @makowskiIndicesEffectExistence2019].

The dynamics of non-linear models was analysed using the
`modelbased::estimate_slopes()` function to compute the variation of the outcome
variable per unit change in VVIQ across its range. We summarised the evidence
for positive or negative slopes using a custom `check_slope_evidence()` function
that computes the PD and ROPE proportions of the slope estimates.

The setup of *marginaleffects* options and model priors is done in the chunk
below.

```{r}
#| label: bayesian-setup

options("marginaleffects_safe" = FALSE)
draws <- seq(1, 4000, 1) # To limit draws that will be used for marginaleffects

priors <- c(brms::prior(normal(0, 20), class = "b"))
refit  <- "never"
```

Prior predictive check were performed to ensure that the priors set on the
models were adequate. This was done by fitting a model with the same structure
as the planned analyses but sampling only from the prior distributions. The
posterior predictive distributions of this prior-only model were then plotted to
check that they covered a reasonable range of values.

```{r}
#| label: test_prior
#| message: false
#| warning: false
#| fig-width: 7
#| fig-height: 3.5
#| fig-alt: >
#|  Prior predictive distributions.

lm_prior <-
  fit_brms_model(
    formula = tas ~ vviq_group_4,
    data = all_data,
    prior = priors,
    sample_prior = "only",
    file_refit = refit,
    file = system.file("models/lm_prior.rds", package = "aphantasiaEmotions")
  )

performance::check_predictions(lm_prior, draw_ids = 1:12) |>
  plot() +
  ggplot2::labs(title = "Prior Predictive Check") +
  theme_pdf(base_size = 12)
```

Here we go!

## Analysis of total TAS-20 scores

### Linear categorical model

```{r}
#| label: plot-tot-lm
#| fig.width: 7
#| fig.height: 3.5
#| warning: false
#| fig-alt: >
#|  Results of the linear modelling of the total TAS-20 with the VVIQ groups.

# Group model
lm_tot <-
  fit_brms_model(
    formula = tas ~ vviq_group_4,
    data = all_data,
    prior = priors,
    file_refit = refit,
    file = system.file("models/lm_tot.rds", package = "aphantasiaEmotions")
  )

# Posterior predictive check
performance::check_predictions(lm_tot, draw_ids = 1:12) |>
  plot() +
  theme_pdf(base_size = 12)

contrasts_tot <-
  marginaleffects::comparisons(
    lm_tot,
    variables = list("vviq_group_4" = "pairwise"),
    draw_ids = draws
  )

report_rope(contrasts_tot, contrast) |> knitr::kable()
p_contr_tot <-
  plot_posterior_contrasts(
    contrasts_tot,
    lm_tot,
    base_size = 12,
    rope_txt = 3,
    dot_size = 1,
    x_lab = "Effect size (TAS score difference)",
    axis_relative_x = 0.7
  )

# Group plot
p_tot <-
  plot_group_violins(
    tas ~ vviq_group_4,
    y_lab = "Total TAS Score",
    base_size = 12
  ) +
  plot_alexithymia_cutoff(txt_size = 2, txt_x = 1.4, label = "Alexithymia") +
  scale_discrete_aphantasia() +
  scale_x_aphantasia(add = c(0.4, 0.7))

plot(p_tot + p_contr_tot)
```

### Nonlinear continuous model

```{r}
#| label: plot-tot-gam
#| fig.width: 7
#| fig.height: 3.5
#| warning: false
#| fig-alt: >
#|  Results of the non-linear modelling of the total TAS-20 with the VVIQ scores

gam_tot <-
  fit_brms_model(
    formula = tas ~ s(vviq),
    data = all_data,
    prior = priors,
    file_refit = refit,
    file = system.file("models/gam_tot.rds", package = "aphantasiaEmotions")
  )

# Posterior predictive check
performance::check_predictions(gam_tot, draw_ids = 1:12) |>
  plot() +
  theme_pdf(base_size = 12)

slopes_tot <-
  modelbased::estimate_slopes(
    gam_tot,
    trend = "vviq",
    by = "vviq",
    length = 75,
    rope_ci = 1
  )

check_slope_evidence(slopes_tot) |> knitr::kable()
p_slopes_tot <-
  plot_gam_slopes(
    slopes_tot,
    .f_groups = dplyr::case_when(
      vviq <= 24 ~ 1,
      vviq <= 35 ~ 2,
      vviq <= 36 ~ 3,
      vviq <= 45 ~ 4,
      vviq <= 76 ~ 5,
      vviq <= 80 ~ 6
    ),
    y_lab = "TAS variation per unit change in VVIQ",
    base_size = 12
  )

p_gam_tot <-
  plot_gam_means(
    gam_tot,
    y_title = "Total TAS score",
    legend_relative = 0.85,
    base_size = 12
  ) +
  plot_coloured_subjects(
    x = all_data$vviq,
    y = all_data$tas,
    size = 1
  ) +
  plot_alexithymia_cutoff(txt_x = 26, label = "Alexithymia") +
  scale_discrete_aphantasia() +
  scale_x_vviq()

plot(p_gam_tot + p_slopes_tot)
```

## Analysis of TAS-20 sub-scale scores

### Linear categorical models

```{r}
#| label: plot-sub-lm
#| fig.width: 7
#| fig.height: 7
#| warning: false
#| fig-alt: >
#|  Results of the linear modelling of the TAS-20 subscales with the VVIQ groups.

# Subscale group models
lm_dif <-
  fit_brms_model(
    formula = tas_identify ~ vviq_group_4,
    data = all_data,
    prior = priors,
    file_refit = refit,
    file = system.file("models/lm_dif.rds", package = "aphantasiaEmotions")
  )

lm_ddf <-
  fit_brms_model(
    formula = tas_describe ~ vviq_group_4,
    data = all_data,
    prior = priors,
    file_refit = refit,
    file = system.file("models/lm_ddf.rds", package = "aphantasiaEmotions")
  )

lm_eot <-
  fit_brms_model(
    formula = tas_external ~ vviq_group_4,
    data = all_data,
    prior = priors,
    file_refit = refit,
    file = system.file("models/lm_eot.rds", package = "aphantasiaEmotions")
  )

# Posterior predictive checks
pp_dif_lm <-
  performance::check_predictions(lm_dif, draw_ids = 1:12) |>
  plot() +
  theme_pdf(base_size = 12)

pp_ddf_lm <-
  performance::check_predictions(lm_ddf, draw_ids = 1:12) |>
  plot() +
  theme_pdf(base_size = 12)

pp_eot_lm <-
  performance::check_predictions(lm_eot, draw_ids = 1:12) |>
  plot() +
  theme_pdf(base_size = 12)

plot(pp_dif_lm / pp_ddf_lm / pp_eot_lm)
contrasts_dif <-
  marginaleffects::comparisons(
    lm_dif,
    variables = list("vviq_group_4" = "pairwise"),
    draw_ids = draws
  )

report_rope(contrasts_dif, contrast) |> knitr::kable()
contrasts_ddf <-
  marginaleffects::comparisons(
    lm_ddf,
    variables = list("vviq_group_4" = "pairwise"),
    draw_ids = draws
  )

report_rope(contrasts_ddf, contrast) |> knitr::kable()
contrasts_eot <-
  marginaleffects::comparisons(
    lm_eot,
    variables = list("vviq_group_4" = "pairwise"),
    draw_ids = draws
  )

report_rope(contrasts_eot, contrast) |> knitr::kable()

# Subscale group plots
p_dif <-
  plot_group_violins(
    tas_identify ~ vviq_group_4,
    y_lab = "TAS DIF Score",
    base_size = 12
  ) +
  scale_discrete_aphantasia() +
  scale_x_aphantasia(add = c(0.4, 0.7))
p_ddf <-
  plot_group_violins(
    tas_describe ~ vviq_group_4,
    y_lab = "TAS DDF Score",
    base_size = 12
  ) +
  scale_discrete_aphantasia() +
  scale_x_aphantasia(add = c(0.4, 0.7))
p_eot <-
  plot_group_violins(
    tas_external ~ vviq_group_4,
    y_lab = "TAS EOT Score",
    base_size = 12
  ) +
  scale_discrete_aphantasia() +
  scale_x_aphantasia(add = c(0.4, 0.7))

# Subscale contrast plots
p_dif_contr <-
  plot_posterior_contrasts(
    contrasts_dif,
    lm_dif,
    xlab = "Effect size (DIF score difference)",
    base_size = 12,
    dot_size = 1,
    axis_relative_x = 0.7
  )
p_ddf_contr <-
  plot_posterior_contrasts(
    contrasts_ddf,
    lm_ddf,
    xlab = "Effect size (DDF score difference)",
    base_size = 12,
    dot_size = 1,
    axis_relative_x = 0.7
  )
p_eot_contr <-
  plot_posterior_contrasts(
    contrasts_eot,
    lm_eot,
    xlab = "Effect size (EOT score difference)",
    base_size = 12,
    dot_size = 1,
    axis_relative_x = 0.7
  )

((p_dif + p_dif_contr) + plot_layout(tag_level = "new")) /
  ((p_ddf + p_ddf_contr) + plot_layout(tag_level = "new")) /
  ((p_eot + p_eot_contr) + plot_layout(tag_level = "new")) +
  plot_annotation(tag_levels = c("A", "1")) &
  ggplot2::theme(plot.tag = ggplot2::element_text(size = 10, face = "bold"))
```

### Nonlinear continuous models

```{r}
#| label: plot-sub-gam
#| fig.width: 7
#| fig.height: 7
#| warning: false
#| fig-alt: >
#|  Results of the non-linear modelling of the TAS-20 sub-scales with the VVIQ scores.

# Subscale GAM models
gam_dif <-
  fit_brms_model(
    formula = tas_identify ~ s(vviq),
    data = all_data,
    prior = priors,
    file_refit = refit,
    file = system.file("models/gam_dif.rds", package = "aphantasiaEmotions")
  )

gam_ddf <-
  fit_brms_model(
    formula = tas_describe ~ s(vviq),
    data = all_data,
    prior = priors,
    file_refit = refit,
    file = system.file("models/gam_ddf.rds", package = "aphantasiaEmotions")
  )

gam_eot <-
  fit_brms_model(
    formula = tas_external ~ s(vviq),
    data = all_data,
    prior = priors,
    file_refit = refit,
    file = system.file("models/gam_eot.rds", package = "aphantasiaEmotions")
  )

# Posterior predictive checks
pp_dif_gam <-
  performance::check_predictions(gam_dif, draw_ids = 1:12) |>
  plot() +
  theme_pdf(base_size = 12)

pp_ddf_gam <-
  performance::check_predictions(gam_ddf, draw_ids = 1:12) |>
  plot() +
  theme_pdf(base_size = 12)

pp_eot_gam <-
  performance::check_predictions(gam_eot, draw_ids = 1:12) |>
  plot() +
  theme_pdf(base_size = 12)

plot(pp_dif_gam / pp_ddf_gam / pp_eot_gam)
slopes_dif <-
  modelbased::estimate_slopes(gam_dif, trend = "vviq", by = "vviq", length = 75)

check_slope_evidence(slopes_dif) |> knitr::kable()
slopes_ddf <-
  modelbased::estimate_slopes(gam_ddf, trend = "vviq", by = "vviq", length = 75)

check_slope_evidence(slopes_ddf) |> knitr::kable()
slopes_eot <-
  modelbased::estimate_slopes(gam_eot, trend = "vviq", by = "vviq", length = 75)

check_slope_evidence(slopes_eot) |> knitr::kable()

p_slopes_dif <-
  plot_gam_slopes(
    slopes_dif,
    .f_groups = dplyr::case_when(
      vviq <= 22 ~ 1,
      vviq <= 31 ~ 2,
      vviq <= 38 ~ 3,
      vviq <= 57 ~ 4,
      vviq <= 74 ~ 5,
      vviq <= 80 ~ 6
    ),
    y_lab = "DIF variation per unit change in VVIQ",
    axis.title.y = ggplot2::element_text(size = 9),
    base_size = 12
  )

p_slopes_ddf <-
  plot_gam_slopes(
    slopes_ddf,
    .f_groups = dplyr::case_when(
      vviq <= 22 ~ 1,
      vviq <= 46 ~ 2,
      vviq <= 74 ~ 3,
      vviq <= 80 ~ 4
    ),
    y_lab = "DDF variation per unit change in VVIQ",
    legend.position = "none",
    axis.title.y = ggplot2::element_text(size = 9),
    base_size = 12
  )

p_slopes_eot <-
  plot_gam_slopes(
    slopes_eot,
    .f_groups = dplyr::case_when(
      vviq <= 23 ~ 1,
      vviq <= 42 ~ 2,
      vviq <= 69 ~ 3,
      vviq <= 80 ~ 4
    ),
    y_lab = "EOT variation per unit change in VVIQ",
    legend.position = "none",
    axis.title.y = ggplot2::element_text(size = 9),
    base_size = 12
  )

# Subscale GAM plots
p_gam_dif <-
  plot_gam_means(
    gam_dif,
    y_title = "TAS DIF score",
    legend_relative = 0.85,
    base_size = 12
  ) +
  plot_coloured_subjects(
    x = all_data$vviq,
    y = all_data$tas_identify,
    size = 1
  ) +
  scale_discrete_aphantasia() +
  scale_x_vviq()

p_gam_ddf <-
  plot_gam_means(
    gam_ddf,
    y_title = "TAS DDF score",
    legend.position = "none",
    base_size = 12
  ) +
  plot_coloured_subjects(
    x = all_data$vviq,
    y = all_data$tas_describe,
    size = 1
  ) +
  scale_discrete_aphantasia() +
  scale_x_vviq()

p_gam_eot <-
  plot_gam_means(
    gam_eot,
    y_title = "TAS EOT score",
    legend.position = "none",
    base_size = 12
  ) +
  plot_coloured_subjects(
    x = all_data$vviq,
    y = all_data$tas_external,
    size = 1
  ) +
  scale_discrete_aphantasia() +
  scale_x_vviq()

((p_gam_dif + p_slopes_dif) + plot_layout(tag_level = "new")) /
  ((p_gam_ddf + p_slopes_ddf) + plot_layout(tag_level = "new")) /
  ((p_gam_eot + p_slopes_eot) + plot_layout(tag_level = "new")) +
  plot_layout(heights = c(1, 1, 1)) +
  plot_annotation(tag_levels = c("A", "1")) &
  ggplot2::theme(
    plot.tag = ggplot2::element_text(size = 10, face = "bold")
  )
```

--------------------------------------------------------------------------------

```{r}
#| label: session_info
#| echo: false

sessioninfo::session_info()
```

--------------------------------------------------------------------------------

# References